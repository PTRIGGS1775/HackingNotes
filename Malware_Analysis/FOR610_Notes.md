# FOR610

This page is designed to keep track of all relevant commands and tools during the FOR610 course. This is organized by course days but will be sorted by task details later.

- Use your lab to examine the network traffic and packet. Then use a connected machine in the cloud, perhaps a tails instance to pull the malware. To take it a step further you could purchase the space with gift cards.
- Malware bazaar is a place to look at malware samples or github malware repo (the zoo) or vx underground or [malware-traffic-analysis](https://www.malware-traffic-analysis.net/).

## Certification tips
- https://www.giac.org/certifications/reverse-engineering-malware-grem/
- You will be asked to apply your knowledge.
- Do your labs multiple times.
- Create a good index
- You'll get two practice tests. Get yourself ready first before taking practice tests.

FYI, Exam Takers
- You will be able to access GIAC exam and both mock test 7 days after your course/training has concluded
- You will have 4 months to take the exam and 161 days to complete practice tests.
- You will have access to all the course recordings and materials for 4 months, so that you can prepare for the exam.
- If you feel 4 months is not enough you can purchase 45 days extension for $459
- This option will become available in you account 15 days before your current deadline
- Your course and all the courseware will be extended alongside the exam.
- You can purchase up to 10 extensions.


Certification Study Help
Better GIAC Testing with Pancakes - https://tisiphone.net/2015/08/18/giac-testing/
Matthew Toussain - Get Certified! All You Need to Know to Rock GIAC Exams - https://www.youtube.com/watch?v=jYQ88CYGS8s
Matthew Toussain - Wargaming GIAC Certifications - https://www.opensecurity.io/blog/wargaming-giac-certifications
Matthew Toussain - Rocking the GIAC Exam with Voltaire - https://www.youtube.com/watch?v=bHpkTArlXWc&t=93s
Matthew Toussain - Voltaire (Index building App) - https://voltaire.publickey.io/
Anki Powerfil Flash Cards - https://apps.ankiweb.net/
Develop Technical Recall Skills: Spaced Repetition with Anki - https://www.youtube.com/watch?v=kfJjtztHFrE
Ron Hamann -Are You Certifiable? | SANS@MIC Talk - https://www.youtube.com/watch?v=vHTGJJZ0UcQ&t=3s
https://www.youtube.com/watch?v=v-FBLbhv4aI


# Day 1

## Static Analysis
- Process
    1. Review strings with `floss` or `pestr {mal.exe} | egrep  '^[-0-9a-zA-Z.+/ ();=\\]+$'`
    2. Review structure with `pestudio` (Win) and `peframe` (Lin) and `detectiteasy` (both)
        - Identify if it is 64 or 32 for later.

### Review Strings
- The goal is to be looking for import information, windows APIs or other details that can indicate the nature of the malware.
```bash
# Floss.
floss {mal.exe} 

#PEstr with REGEX to clean view
pestr {mal.exe} | egrep  '^[-0-9a-zA-Z.+/ ();=\\]+$'
```

### Review structure of PE
- Look at headers and imports and check to see any anomolies.
```bash
# PEStudio
    ## GUI based and easy to click through. Sort by blacklist to see interesting APIs or strings.
    ## Note: Reckoning in the imports section is a typo for Recon.
"Drag and drop the exe into the PEStudio window"

# PEFrame
    ## Takes a minute or so to run depending on size. XLM Error is expected. Shows behavior and possible investigation tools. Also has an import table hash.
    ## Beware of false positives, but dig into the possibility.
peframe {mal.exe}

#Detect it easy
    ## Shows you how the exe was compiled and other useful buttons with similar functionality to other tools in the course.
"Open gui and load exe into the tool"
```

## Dynamic Analysis
- Process
    1. **Launch** `Process Hacker` and `Process Monitor` on Windows REM Workstation. 
        - **Turn off capture** on `Process Monitor` momentarily.
    2. Launch `Regshot` and **take the first snapshot** using this tool on Windows REM Workstation.
    3. Launch `Wireshark` on REMnux and start its capture.
    4. Activate monitoring in `Process Monitor`\
    **!! Infect Windows REM Workstation with brbbot.exe. (You want the malware to have admin rights to let it have full potential).**
    5. **Terminate** the brbbot.exe process and stop capture in `Process Monitor`.
    6. **Stop capture** in `Wireshark`.
    7. **Take the second** `Regshot` **snapshot** and **compare** it to the first one, examining Regshot's report.
        - Go to some of the locations created and review what was made with other tools.
    8. **Analyze** Process Monitor's log file using `ProcDOT`.
        - Focus on the things that are orange or red.
    9. **Examine** `Wireshark's` log file.
        1. Look at DNS
        2. Look at HTTP (HTTPS is encrypted and likely unhelpful)
        3. Depending on sample look at SMB
        4. Do basic wiresharking to review protocols, conversations, etc.

- Process to Modify Lab for Network Analysis. 
    - We us resource starvation to see how the malware responds, maybe it tries different DNS servers
    1. Launch `fakedns` on REMnux and confirm that it is working.
    2. Start a new capture in `Wireshark` on REMnux, and then reinfect Windows REM Workstation with brbbot.exe.
    3. Terminate brbbot.exe and stop capture in Wireshark, and then examine the log.
    4. Start the web server on REMnux `httpd start`, activate capture in Wireshark, and then reinfect Windows REM Workstation with brbbot.exe.
    5. Terminate brbbot.exe and stop capture in Wireshark, and then examine the log.
    6. Save the encoded payload from the HTTP traffic for later analysis.

### Emulation
- This is a step between disassembly and debugging. Uses specialized tools to preview the key actions the specimen will take when it runs.
- Emulators work regardless of the OS.
- Use the review of the emulator to inform your debugging.
- Emulators have a hard time with packed samples.

```bash
# Speakeasy
speakeasy -t brbbot.exe -o brbbot.json &> brbbot.txt #The redirect is for the redirection of all output of the command while its running

    # To review speak easy use jq
    # jq is a tool for processing JSON inputs, applying the given filter to its JSON text inputs and producing the filter's results as JSON on standard output.
        jq -r '.. | select(.api_name?)' brbbot.json #.. is all json objects. select is a select statement and the question mark

# Capa
capa {mal.exe} # Provides a quick overview and matching numbers to the MITRE or MBC frameworks.
capa -vv {mal.exe} # Provides verbose details with where in memory the event was called.
```

### Debugging
- Case of command doesn't matter, but case of function does.
- We don't want to step into windows API and debug that, we want to debug user code.
- Debuggers load information into the application so you can view what is happening at certain points, like the details of a command before it is encrypted.

```bash
# x32/64 dbg
    ##Set breakpoints on certain functions by typing in the command bar at the bottom of x32/64 dbg

bp {FunctionName}
    ## You can find the handle (known from looking at the documentation) by going to handles at the top and refreshing.
    ## Under debug, click run to user code.
    ## You can also select a line and then run to selection.
    ## Debug by running to the line after the instruction you're interested in.

# API Monitor
    ## Must close debugger to load file
    ## API monitor is faster than a debugger at times.
"Open api monitor and select new process"
```

### Intercepting HTTPS traffic

- INETSim receives HTTPS traffic where wireshark will not. Simply run it on the remnux machine then review the logs at `sudo vim /var/log/inetsim/service.log`
- Alternatively you can launch fiddler on your windows machine and run the exe.
- To deal with hard coded IP address redirects you must adjust IP tables.
    - On regular linux `iptables -t nat -A PREROUTING -i eth0 -j REDIRECT`
    - on remnux `httpd start` then `accept-all-ips start`
    - Alternatively, fiddler makes this a lot easier.